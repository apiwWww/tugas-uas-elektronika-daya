<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Realtime - GitHub + Gauge</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      text-align: center;
      color: #333;
    }
    h1 {
      color: #007bff;
      margin-bottom: 30px;
    }
    .dashboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 250px;
      min-height: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .value {
      font-size: 28px;
      font-weight: bold;
      color: #007bff;
      margin: 10px 0;
    }
    .label {
      font-size: 14px;
      color: #6c757d;
      margin-bottom: 15px;
    }

    /* GAUGE STYLES — PASTIKAN INI TIDAK ADA TYPO */
    .gauge {
      width: 160px;
      height: 80px;
      background: #e9ecef;
      border-radius: 80px 80px 0 0;
      position: relative;
      margin: 10px auto 20px;
      overflow: hidden;
    }
    .gauge-center {
      width: 10px;
      height: 10px;
      background: #333;
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
    }
    .needle {
      width: 4px;
      height: 75px;
      background: #dc3545;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform-origin: bottom;
      transform: translateX(-50%) rotate(90deg);
      transition: transform 0.5s ease-out;
      z-index: 1;
    }

    canvas {
      margin-top: 10px;
      height: 150px !important;
    }
  </style>
</head>
<body>

<h1>Dashboard Monitoring Realtime (GitHub + Gauge)</h1>
<div class="dashboard">
  <div class="card">
    <h2>Tegangan</h2>
    <div class="value" id="voltageVal">0.00</div>
    <div class="label">Volts (V)</div>
    <div class="gauge">
      <div class="needle" id="voltageNeedle"></div>
      <div class="gauge-center"></div>
    </div>
    <canvas id="voltageChart"></canvas>
  </div>
  <div class="card">
    <h2>Arus</h2>
    <div class="value" id="currentVal">0.00</div>
    <div class="label">Amperes (A)</div>
    <div class="gauge">
      <div class="needle" id="currentNeedle"></div>
      <div class="gauge-center"></div>
    </div>
    <canvas id="currentChart"></canvas>
  </div>
  <div class="card">
    <h2>Daya</h2>
    <div class="value" id="powerVal">0.00</div>
    <div class="label">Watts (W)</div>
    <div class="gauge">
      <div class="needle" id="powerNeedle"></div>
      <div class="gauge-center"></div>
    </div>
    <canvas id="powerChart"></canvas>
  </div>
  <div class="card">
    <h2>Resistansi</h2>
    <div class="value" id="resistanceVal">0.00</div>
    <div class="label">Ohm (Ω)</div>
    <div class="gauge">
      <div class="needle" id="resistanceNeedle"></div>
      <div class="gauge-center"></div>
    </div>
    <canvas id="resistanceChart"></canvas>
  </div>
</div>

<script>
// ✅ URL CSV-mu (sudah benar!)
const CSV_URL = "https://raw.githubusercontent.com/apiwWww/tugas-uas-elektronika-daya/refs/heads/main/data_simulasi.csv";

// Konfigurasi maksimum untuk gauge
const MAX_VALUES = {
  voltage: 300,
  current: 10,
  power: 3000,
  resistance: 300
};

let allRows = [];
let startTime = null;
const MAX_POINTS = 30;

// Inisialisasi chart & simpan referensi needle
const metrics = ['voltage', 'current', 'power', 'resistance'];
const charts = {};
const needles = {};

metrics.forEach(metric => {
  // Simpan elemen needle
  needles[metric] = document.getElementById(`${metric}Needle`);

  // Buat chart
  const ctx = document.getElementById(`${metric}Chart`).getContext('2d');
  const color = 
    metric === 'voltage' ? 'rgba(0,123,255,1)' :
    metric === 'current' ? 'rgba(40,167,69,1)' :
    metric === 'power'    ? 'rgba(255,193,7,1)' : 'rgba(220,53,69,1)';
  
  charts[metric] = new Chart(ctx, {
    type: 'line',
     {
      labels: [],
      datasets: [{
         [],
        borderColor: color,
        backgroundColor: color.replace('1)', '0.1)'),
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true;
      maintainAspectRatio: false;
      animation: false;
      scales: {
        y: { beginAtZero: false },
        x: { display: false }
      },
      plugins: { legend: { display: false } }
    }
  });
});

// Parse CSV
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const cols = line.split(',');
    return {
      time: cols[0],
      voltage: parseFloat(cols[1]),
      current: parseFloat(cols[2]),
      power: parseFloat(cols[3])
    };
  });
}

// Update tampilan (angka + gauge + chart)
function updateDashboard(index) {
  if (index >= allRows.length) return;

  const row = allRows[index];
  const V = row.voltage;
  const I = row.current;
  const P = row.power;
  const R = I > 0.01 ? V / I : 0;

  const values = { voltage: V, current: I, power: P, resistance: R };

  // Update semua komponen
  metrics.forEach(metric => {
    const val = values[metric];
    const max = MAX_VALUES[metric];

    // ✅ Update angka
    document.getElementById(`${metric}Val`).textContent = val.toFixed(2);

    // ✅ Update gauge (0–max → 0–180 derajat)
    const capped = Math.min(Math.max(0, val), max);
    const deg = (capped / max) * 180;
    needles[metric].style.transform = `translateX(-50%) rotate(${deg}deg)`;

    // ✅ Update chart
    const dataset = charts[metric].data.datasets[0].data;
    const labels = charts[metric].data.labels;
    if (dataset.length >= MAX_POINTS) {
      dataset.shift();
      labels.shift();
    }
    dataset.push(val);
    labels.push('');
    charts[metric].update();
  });
}

// Load CSV dari GitHub
async function init() {
  try {
    const res = await fetch(`${CSV_URL}?t=${Date.now()}`);
    const csvText = await res.text();
    allRows = parseCSV(csvText);
    console.log(`✅ ${allRows.length} baris data dimuat`);

    startTime = Date.now();
    updateDashboard(0); // tampilkan data pertama
  } catch (err) {
    console.error("❌ Gagal memuat CSV:", err);
  }
}

// Jalankan tiap detik
function playData() {
  if (allRows.length === 0) return;
  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
  const index = Math.min(elapsedSec, allRows.length - 1);
  updateDashboard(index);
}

// Mulai
init();
setInterval(playData, 1000);
</script>

</body>
</html>
