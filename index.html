<script>
// Konfigurasi
const CSV_URL = "https://raw.githubusercontent.com/apiwWww/tugas-uas-elektronika-daya/refs/heads/main/data_simulasi.csv";
const MAX_VALUES = { voltage: 300, current: 10, power: 3000, resistance: 300 };
let allRows = [];
let startTime = null;
const MAX_POINTS = 30;

// Fungsi bantu SVG
function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
  const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
  return {
    x: centerX + (radius * Math.cos(angleInRadians)),
    y: centerY + (radius * Math.sin(angleInRadians))
  };
}
function describeArc(x, y, radius, startAngle, endAngle) {
  const start = polarToCartesian(x, y, radius, endAngle);
  const end = polarToCartesian(x, y, radius, startAngle);
  const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
  return ["M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y].join(" ");
}

// Inisialisasi chart
const metrics = ['voltage', 'current', 'power', 'resistance'];
const charts = {};
const colors = {
  voltage: 'rgba(0,123,255,1)',
  current: 'rgba(40,167,69,1)',
  power: 'rgba(255,193,7,1)',
  resistance: 'rgba(220,53,69,1)'
};

metrics.forEach(metric => {
  const ctx = document.getElementById(`${metric}Chart`).getContext('2d');
  charts[metric] = new Chart(ctx, {
    type: 'line',
    data: { // <--- KOREKSI
      labels: [],
      datasets: [{
        data: [], // <--- KOREKSI
        borderColor: colors[metric],
        backgroundColor: colors[metric].replace('1)', '0.1)'),
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        y: { beginAtZero: false },
        x: { display: false }
      },
      plugins: { legend: { display: false } }
    }
  });
});

// Parse CSV
function parseCSV(text) {
  const lines = text.trim().split('\n');
  return lines.slice(1).map(line => {
    const cols = line.split(',');
    return {
      time: cols[0],
      voltage: parseFloat(cols[1]),
      current: parseFloat(cols[2]),
      power: parseFloat(cols[3])
    };
  });
}

// Update dashboard
function updateDashboard(index) {
  if (index >= allRows.length) return;
  const row = allRows[index];
  const V = row.voltage;
  const I = row.current;
  const P = row.power;
  // Hitung Resistansi (R = V/I). Beri nilai 0 jika I terlalu kecil untuk menghindari pembagian dengan nol.
  const R = I > 0.01 ? V / I : 0; 
  const values = { voltage: V, current: I, power: P, resistance: R };

  metrics.forEach(metric => {
    const val = values[metric];
    const max = MAX_VALUES[metric];
    document.getElementById(`${metric}Val`).textContent = val.toFixed(2);

    // Update arc (Setengah lingkaran)
    const capped = Math.min(Math.max(0, val), max);
    // Sudut dihitung dari 0 (paling kiri) hingga 180 (paling kanan)
    const angle = (capped / max) * 180; 
    // Fungsi describeArc mengambil sudut 0 hingga 180, bukan -90 hingga 90
    document.getElementById(`arc-${metric}`).setAttribute('d', describeArc(100, 100, 80, 0, angle));

    // Update needle
    const needleLine = document.getElementById(`needle-${metric}`);
    if (needleLine) {
      // Putar jarum: 0 derajat berada di posisi jam 6 (-90 derajat di sumbu X).
      // Jadi, putar sebesar (angle - 90) derajat
      needleLine.setAttribute('transform', `rotate(${angle - 90} 100 100)`);
    }

    // Update chart
    const dataset = charts[metric].data.datasets[0].data;
    const labels = charts[metric].data.labels;
    if (dataset.length >= MAX_POINTS) {
      dataset.shift();
      labels.shift();
    }
    dataset.push(val);
    labels.push('');
    charts[metric].update();
  });
}

// Load data
async function init() {
  try {
    // Tambahkan parameter waktu untuk memastikan file diunduh terbaru (menghindari cache)
    const res = await fetch(`${CSV_URL}?t=${Date.now()}`); 
    const csvText = await res.text();
    allRows = parseCSV(csvText);
    startTime = Date.now();
    // Langsung tampilkan data pertama
    updateDashboard(0); 
  } catch (err) {
    console.error("Gagal memuat data:", err);
    // Tampilkan pesan error di konsol
  }
}

// Main loop
init();
setInterval(() => {
  if (allRows.length === 0) return;
  // Hitung indeks data yang sesuai dengan detik yang telah berlalu
  const elapsedSec = Math.floor((Date.now() - startTime) / 1000); 
  const index = Math.min(elapsedSec, allRows.length - 1);
  updateDashboard(index);
}, 1000); // Update setiap 1 detik (1000 ms)
</script>
