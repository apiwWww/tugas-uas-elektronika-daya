<script>

// ====================== LINK CSV ======================
const CSV_URL = "https://raw.githubusercontent.com/apiwWww/tugas-uas-elektronika-daya/refs/heads/main/data_simulasi%20(2).csv";

// ====================== SETUP CHART ======================
const chart1 = new Chart(document.getElementById("chart1"), {
  type: 'line',
  data: { 
    labels: [],
    datasets: [{
      label: 'Voltage',
      data: [],
      borderColor: 'blue',
      backgroundColor: 'rgba(0,123,255,0.2)',
      pointRadius: 0,
      tension: 0.3
    }]
  }
});

const chart2 = new Chart(document.getElementById("chart2"), {
  type: 'line',
  data: { 
    labels: [],
    datasets: [{
      label: 'Current',
      data: [],
      borderColor: 'green',
      backgroundColor: 'rgba(0,255,0,0.2)',
      pointRadius: 0,
      tension: 0.3
    }]
  }
});

const chart3 = new Chart(document.getElementById("chart3"), {
  type: 'line',
  data: { 
    labels: [],
    datasets: [{
      label: 'Power',
      data: [],
      borderColor: 'purple',
      backgroundColor: 'rgba(128,0,128,0.2)',
      pointRadius: 0,
      tension: 0.3
    }]
  }
});

// ====================== CSV LOADER ======================
let dataRows = [];
let index = 0;

async function loadCSV() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.trim().split("\n").map(r => r.split(","));
  dataRows = rows.slice(1);
}

// ====================== UPDATE PER BARIS ======================
function updateStep() {

  // âžœ FIX: kalau habis, ulang dari awal
  if (index >= dataRows.length) {
    index = 0;
  }

  const row = dataRows[index];

  const time   = row[0];
  const param1 = parseFloat(row[1]);
  const param2 = parseFloat(row[2]);
  const param3 = parseFloat(row[3]);

  // ================= GAUGE ==================
  updateGauge("needle1", param1);
  updateGauge("needle2", param2);
  updateGauge("needle3", param3);

  document.getElementById("val1").textContent = param1.toFixed(2);
  document.getElementById("val2").textContent = param2.toFixed(2);
  document.getElementById("val3").textContent = param3.toFixed(2);

  // ================= GRAFIK ==================
  addData(chart1, time, param1);
  addData(chart2, time, param2);
  addData(chart3, time, param3);

  index++; 
}

// ====================== LIMIT DATA ======================
function addData(chart, label, value) {
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(value);

  if (chart.data.labels.length > 50) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }

  chart.update();
}

// ====================== GAUGE ROTATION ======================
function updateGauge(id, value) {
  const deg = (value / 300) * 180 - 90;
  document.getElementById(id).style.transform = `rotate(${deg}deg)`;
}

// ====================== START ======================
loadCSV().then(() => {
  updateStep();               
  setInterval(updateStep, 1000);
});

</script>
